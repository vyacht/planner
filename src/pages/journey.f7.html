<template>
    <div class="page">
        <div class="page-content">
            <div class="demo-map-container" style="z-index: 0; height: 100%"></div>
            <div style="position: absolute; z-index: 2; left: 32px; top: 6px;">
                <a href="#" class="back link">
                    <i class="icon icon-back" style="color: black"></i>
                    <span class="if-not-md">Back</span>
                </a>
            </div>
        </div>


            <div id="journey-sheet-modal" class="sheet-modal demo-sheet-swipe-to-step" style="height:auto; ">
                <div class="sheet-modal-inner">
                    <div class="swipe-handler"></div>
                    <div class="sheet-modal-swipe-step">
                        <div class="margin-top text-align-left"
                            style="margin:12px; padding-left: calc(var(--f7-list-item-padding-horizontal) + var(--f7-safe-area-left));">
                            This is a test
                        </div>
                    </div>

            {{#journey}}
            {{#sections}}
            {{#js_if 'this.type == "public_transport"'}}

            <div class="card">
                <div class="card-content ">
                    <div class="row-journey">
                        <div class="col-journey-time">{{departureTime}}</div>
                        <div class="col-journey-graphics-top">&nbsp;</div>
                        <div class="col-journey-main">{{departurePlace}}</div>
                    </div>
                    <div class="row-journey">
                        <div class="col-journey-time">&nbsp;</div>
                        
                        <div class="col-journey-graphics-mid">
                            &nbsp;
                        </div>
                        <div class="col-journey-main-mid">
                            {{journeySectionChip this}}
                            ({{duration}} min)
                        </div>
                    </div>
                    <div class="row-journey">
                        <div class="col-journey-time">{{arrivalTime}}</div>
                        <div class="col-journey-graphics-bottom">&nbsp;</div>
                        <div class="col-journey-main">{{arrivalPlace}}</div>
                    </div>
                </div>
            </div>
            {{/js_if}}
            {{/sections}}
            {{/journey}}
                    
                </div>
            </div>


    </div>
</template>
<script>
    import Journeys from '../js/journey.js';
    import Utils from '../js/utils.js';

    export default {
        props: {
            id: String,
        },
        data() {
            const self = this;
            // Reference to root Store object
            //var store = self.$root.journey;
            return {
                mapInitialized: false,
                journey: null,
            }
        },
        methods: {
            initMap: function () {
                var self = this;
                self.mymap = L.map(self.$el.find('.demo-map-container')[0], {
                    zoomControl: false
                }).setView([59.8, 17.6], 10);
                var topoUrl = 'http://{s}.tile.opentopomap.org/{z}/{x}/{y}.png';
                var topoAttribution =
                    'Kartendaten: <a href="https://openstreetmap.org">OpenStreetMap</a>, <a href="http://viewfinderpanoramas.org">SRTM</a> | Kartendarstellung: <a href="https://opentopomap.org">OpenTopoMap</a>, &copy; <a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>';

                L.tileLayer(
                    topoUrl, {
                        maxZoom: 18,
                        attribution: topoAttribution,
                        id: 'mapbox.streets'
                    }).addTo(self.mymap);

                self.markerLayerGroup = L.layerGroup().addTo(self.mymap);
                self.tripLayer = L.geoJSON().addTo(self.mymap);
                self.mapInitialized = true;
            },
            getTestJourney: function () {
                var self = this;
                var app = self.$app;

                var fromPlace = {
                    place: {
                        //id: "stop_area:9021003780438000"
                        id: "stop_area:9021003793113000"
                    },
                    type: "stop_area"
                };
                var toPlace = {
                    place: {
                        //id: "stop_area:9021003780050000"
                        id: "stop_area:9021003780232000"
                    },
                    type: "stop_area"
                };

                Journeys.getJourneyBetweenStops(fromPlace, toPlace, 1, function (data) {
                    console.log(data);
                    self.$setState({
                        journey: data[0]
                    });
                    if(self.tripLayer) {
                        console.log("adding trip layer");
                        var lineStyle = {
                            "color": "#4285F4",
                            "weight": 5,
                            "opacity": 0.65
                        };
                        var markerStyle = {
                            "color": "#4285F4",
                            "fillColor": "#ffffff",
                            "weight": 2,
                            "opacity": 1
                        };

                        var bbox = {}, 
                            sections = data[0].sections;
                        for(var s= 0; s < sections.length; s++) {
                            //console.log(sections[s].geojson);
                            var sec = sections[s];
                            if(sec.geojson) {
                                self.tripLayer.addData(sec.geojson);
                                bbox = Utils.getBoundingBox(bbox, sec.geojson);
                            }
                        }
                        self.tripLayer.setStyle(lineStyle);              

                        for(var s= 0; s < sections.length; s++) {
                            //console.log(sections[s].geojson);
                            var sec = sections[s];
                            if(sec.departurePosition)
                                L.circleMarker(sec.departurePosition, {
                                    radius: 5
                                }).addTo(self.markerLayerGroup);
                            if(sec.departurePosition)
                                L.circleMarker(sec.arrivalPosition, {
                                    radius: 5
                                }).addTo(self.markerLayerGroup);
                        }
                        self.markerLayerGroup.setStyle(markerStyle);      

                        var lbbox = [
                            [bbox.latMin, bbox.lonMin],
                            [bbox.latMax, bbox.lonMax],
                        ];

                        //console.log(lbbox);
                        self.mymap.fitBounds(lbbox);
                        //L.rectangle(lbbox, {color: "#ff7800", weight: 1}).addTo(self.mymap);
                    }
                    
                });
            }
        },
        on: {
            pageInit: function () {
                var self = this;

                if (!self.sheetSwipeToStep) {
                    self.sheetSwipeToStep = self.$app.sheet.create({
                        el: '.demo-sheet-swipe-to-step',
                        backdrop: false,
                        swipeToClose: true,
                        swipeToStep: true,
                        push: true,
                    });
                    self.sheetSwipeToStep.open();
                }

                self.getTestJourney();
                //console.log("PAGE INIT JOURNEY", self.$root.journey);
                //self.$setState({journey: this.$root.selectedJourney});
            },
            pageAfterIn: function () {
                var self = this;
                if (self.mapInitialized) return;
                if (!window.L) {
                    //self.loadMapAssets();
                    return;
                }
                self.initMap();
            },
            pageBeforeOut: function () {
                var self = this;
                if (self.sheetSwipeToStep) self.sheetSwipeToStep.close();
            },
            pageBeforeRemove: function () {
                var self = this;
                // Destroy sheet modal when page removed
                if (self.sheetSwipeToStep) self.sheetSwipeToStep.destroy();
            }
        }
    }
</script>