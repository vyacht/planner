<template>
    <div class="page" data-name="main">
        <div class="page-content">
            <div class="demo-map-container" style="z-index: 0; height: 100%"></div>

            <div class="card"
                style="position: absolute; z-index: 2; width: 90%; top: 6px; left: 50%; transform: translate(-50%,0);">
                <div class="card-content" style="background-color: white; ">

                    <!-- Search box formated as list with 1 item-->
                    <div class="list no-safe-areas">
                        <ul>
                            <li>
                                <label class="item-radio item-content">
                                    <div class="item-media">
                                        <a href="#" class="panel-open" data-panel="left">
                                            <i class="icon f7-icons if-not-md">plus_circle</i>
                                            <i class="icon material-icons md-only">menu</i>
                                        </a>
                                    </div>
                                    <div class="item-inner">
                                        <!-- <div class="item-title"> -->
                                        <input id="autocomplete-dropdown-expand-to-dest" type="text"
                                            placeholder="Search your destination" @keyup='onKeyUp()' />
                                        <!-- </div> -->
                                    </div>
                                    <div class="item-after">
                                        <div class="menu" style="align-items: right;">
                                            <div class="menu-inner">
                                                {{#js_if 'this.typingStarted'}}
                                                <a class="menu-item" @Click='onclearSearchBox()'>
                                                    <div class="menu-item-content icon-only"
                                                        style="background: white; color: var(--f7-input-clear-button-color);">
                                                        <i class="icon material-icons">cancel</i>
                                                    </div>
                                                </a>
                                                {{else}}
                                                <!--
                                                <a class="menu-item" @Click='closeAndRoute("planner")'>
                                                    <div class="menu-item-content icon-only"
                                                        style="background: white; color: #4285F4;">
                                                        <i class="icon material-icons">directions</i>
                                                    </div>
                                                </a>
                                                -->
                                                {{/js_if}}
                                            </div>
                                        </div>
                                    </div>
                                </label>
                            </li>
                        </ul>

                    </div>

                </div>
            </div>
        </div>

        <!--
        <div id="main-test-object" class="card"
            style="position: absolute; z-index: 20000; width: 80%; left: 32px; bottom: 0; transform: translate3d(0, calc(var(--vy-swipe-step, 0)), 0);">
            <div class="card-content" style="background-color: white; ">
                Just a testo
            </div>
        </div>
        -->
        <div id="main-fab">
            <div id="main-nav-btn" class="fab"
                style="right: 16px; bottom: 16px; transform: translate3d(0, calc(var(--vy-swipe-step-progress, 0)), 0);">
                <a href="#" @Click='closeAndRoute("planner")'>
                    <i class="icon material-icons">directions</i>
                </a>
            </div>
            <div id="main-pos-btn" class="fab"
                style="right: 16px; bottom: calc(16px + var(--f7-fab-size) + 8px); transform: translate3d(0, calc(var(--vy-swipe-step-progress, 0)), 0);">
                <a href="#" @click='setPositionToCurrent'>
                    <i class="icon material-icons">gps_fixed</i>
                </a>
            </div>
        </div>

        <div id="sheet-modal" class="sheet-modal demo-sheet-swipe-to-step" style="height:auto; ">

            <div class="sheet-modal-inner">

                <div class="swipe-handler" @click="toggleSwipeStep"></div>

                <div class="sheet-modal-swipe-step">

                    {{#js_if 'this.selectedPlace && this.selectedPlace.place'}}
                    <div class="margin-top text-align-left"
                        style="margin:12px; padding-left: calc(var(--f7-list-item-padding-horizontal) + var(--f7-safe-area-left));">
                        {{selectedPlace.place.name}}
                    </div>
                    {{/js_if}}

                    <div class="list no-hairlines" style="margin:12px">
                        <ul>
                            {{#if linesBus}}
                            <li class="item-content">
                                <div class="item-media">
                                    <i class="icon material-icons" style="background: white; color: #4285F4;">
                                        directions_bus</i>
                                </div>
                                <div class="item-inner">
                                    <div class="item-title">
                                        <div class="item-header">Bus</div>
                                        <div class="disable-scrollbars" style="overflow-x: auto; overflow-y: hidden;">
                                            {{#each linesBus}}
                                            {{transportChipClick id label @root.lineFilter class="transport-chip-clickable"}}
                                            {{/each}}
                                        </div>
                                    </div>
                                </div>
                            </li>
                            {{/if}}
                            {{#if linesTrain}}
                            <li class="item-content">
                                <div class="item-media">
                                    <i class="icon material-icons" style="background: white; color: #4285F4;">
                                        directions_train</i>
                                </div>
                                <div class="item-inner">
                                    <div class="item-title">
                                        <div class="item-header">Train</div>
                                        <div class="disable-scrollbars" style="overflow-x: auto; overflow-y: hidden;">
                                            {{#each linesTrain}}
                                            {{transportChipClick id label @root.lineFilter class="transport-chip-clickable"}}
                                            {{/each}}
                                        </div>
                                    </div>
                                </div>
                            </li>
                            {{/if}}
                        </ul>
                    </div>
                </div>
                <div class="long-seperator"></div>
                {{#if departures}}
                <div class="list no-hairlines" style="margin:12px;">
                    <ul>
                        {{mainDepartureList departures filteredDepartures lineFilter}}
                    </ul>
                </div>
                {{#else}}
                <div></div>
                {{/if}}
            </div>
        </div>
    </div>
</template>
<script>
    import Journeys from '../js/journey.js';
    import Utils from '../js/utils.js';
    export default {
        data: function () {
            return {
                mapInitialized: false,
                mymap: {},
                markerLayerGroup: {},
                selectedPlace: {},
                linesBus: null,
                linesTrain: null,
                linesFerry: null,
                departures: null,
                departuresByLine: null,
                lineFilter: null,
                filteredDepartures: null,
                typingStarted: false // used for showing close or route button
            }
        },
        methods: {
            resetPlace: function () {
                this.$setState({
                    selectedPlace: {},
                    linesBus: null,
                    linesTrain: null,
                    linesFerry: null,
                    departures: null,
                    departuresByLine: null,
                    lineFilter: null,
                    filteredDepartures: null,
                    typingStarted: false
                });
                this.markerLayerGroup.clearLayers();
                this.sheetSwipeToStep.close();
            },
            /* records any key press in input box */
            onKeyUp: function () {
                var inputText = this.$$('#autocomplete-dropdown-expand-to-dest').val();
                if (!inputText || inputText.length == 0)
                    this.resetPlace()
                else
                    this.$setState({
                        typingStarted: true
                    });
            },
            /* button to input box has been hit */
            onclearSearchBox: function () {
                const $inputEl = this.$$('#autocomplete-dropdown-expand-to-dest');
                const previousValue = $inputEl.val();
                $inputEl
                    .val('')
                    .trigger('input change')
                    .focus()
                    .trigger('input:clear', previousValue);
                this.resetPlace();
            },
            /* iterative through all pages */
            toggleLineFilter: function (lineId) {

                var fstate = null;
                if (!this.lineFilter) {
                    //console.log("Filter on (%s)", lineId);
                    fstate = lineId;
                } else {
                    if (this.lineFilter == lineId) {
                        //console.log("Filter off");
                        fstate = null;
                    } else {
                        //console.log("Filter change (%s)", lineId);
                        fstate = lineId;
                    }
                }

                /* filter by selected line */
                var filteredDepartures = [];
                this.departuresByLine.forEach(departure => {
                    if (departure.lineId == lineId) {
                        departure.departureTimes.forEach(dt => {
                            filteredDepartures.push({
                                type: departure.type,
                                direction: departure.direction,
                                label: departure.label,
                                departureTime: dt,
                            });
                        });
                    }
                });

                filteredDepartures.sort(function (a, b) {
                    return a.departureTime.unix() - b.departureTime.unix();
                });

                this.$setState({
                    lineFilter: fstate,
                    filteredDepartures: filteredDepartures
                });
            },
            getDepartures: function (stopArea) {
                var self = this;
                Journeys.getDeparturesFromStopArea(stopArea, function (data) {
                    //console.log(data);
                    self.departures = data.slice(0, 3)
                    self.$update(() => {
                        // DOM updated
                        self.sheetSwipeToStep.open();
                        self.sheetSwipeToStep.stepOpen();
                    });

                });

            },
            getLines: function (stopArea) {

                var self = this;

                Journeys.getLines(stopArea, function (stopArea, lines, departures) {

                    // stupid but it seems std template7 does not understand dicts
                    // - shovel distinct list of lines over to normal array
                    var ll = {};
                    for (var t in lines) {
                        // iterate all types (Bus, Train ...)
                        if (!(t in ll)) ll[t] = [];
                        for (var lid in lines[t]) {
                            // get the label for each line id
                            ll[t].push({
                                label: lines[t][lid],
                                id: lid
                            });
                        }
                    }

                    self.$setState({
                        // maintain null for not set for T7
                        linesBus: ("Bus" in ll) ? ll["Bus"] : null,
                        linesTrain: ("Train" in ll) ? ll["Train"] : null,
                        departuresByLine: departures
                    });

                    self.getDepartures(stopArea);
                });
            },
            closeAndRoute: function (route) {
                // there is probably more elgant ways to route and close

                var self = this;
                var app = self.$app;

                //console.log("open journey", this.journeys[id]);

                if (self.sheetSwipeToStep) {
                    self.sheetSwipeToStep.close();
                    /* destroy has several issues: doesn't seem
                       to work, and makes seemingly unrelated autocomplete go bogus */
                    //self.sheetSwipeToStep.destroy();
                }
                app.views.main.router.navigate({
                    name: route,
                });
            },
            toggleSwipeStep: function () {
                //console.log("TOGGLE STEP");
                //this.sheetSwipeToStep.stepToggle();
                //TODO - doesn't work together with swipeing as the click gets through even then 
            },
            fitMapToPoint(latLng, radius, paddingBottom) {
                var self = this;
                var latLng1 = Utils.destination(latLng, 45, radius),
                    latLng2 = Utils.destination(latLng, 225, radius);

                var bb = L.latLngBounds(latLng2, latLng1);
                console.log(bb, latLng2, latLng1);
                self.mymap.fitBounds(bb, {
                    paddingTopLeft: [0, 0],
                    paddingBottomRight: [0, paddingBottom] // its x, y
                });
            },
            updatePlace: function (type, place) {

                var self = this;
                var app = self.$app;

                console.log("PLACE: ", place)

                // place can be anything
                var pos = L.latLng(place.coords.lat, place.coords.lon);

                self.selectedPlace = {
                    type: type,
                    place: place
                };

                // set marker and center map view
                self.fitMapToPoint(pos, 500, 0);
                self.markerLayerGroup.clearLayers();
                L.marker(pos).addTo(self.markerLayerGroup);

                if (type == "stop_area") {
                    self.getLines(place);
                    this.$root.$setState({
                        toJourney: self.selectedPlace
                    });
                }
            },
            setPositionToCurrent: function () {
                var self = this;
                Utils.getPosition(function (data) {
                    //console.log(data);
                    self.updatePlace("current_position", data.place)
                });
            },
            initMap: function () {
                var latLng = L.latLng(59.8579, 17.6474);

                var self = this;
                self.mymap = L.map(self.$el.find('.demo-map-container')[0], {
                    zoomControl: false
                });
                self.mymap.on('click', function (ev) {
                    console.log(ev.latlng); // 
                });

                self.fitMapToPoint(latLng, 25000, 0);

                var topoUrl = 'http://{s}.tile.opentopomap.org/{z}/{x}/{y}.png';
                var topoAttribution =
                    'Kartendaten: <a href="https://openstreetmap.org">OpenStreetMap</a>, <a href="http://viewfinderpanoramas.org">SRTM</a> | Kartendarstellung: <a href="https://opentopomap.org">OpenTopoMap</a>, &copy; <a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>';

                L.tileLayer(
                    topoUrl, {
                        maxZoom: 18,
                        attribution: topoAttribution,
                        id: 'mapbox.streets'
                    }).addTo(self.mymap);

                self.markerLayerGroup = L.layerGroup().addTo(self.mymap);
                self.mapInitialized = true;
            },
            sheetOnTheMove: function (progress, open = false) {
                // taken from sheet-class.js
                var self = this;
                var el = self.sheetSwipeToStep.$el;
                const $swipeStepEl = el.find('.sheet-modal-swipe-step').eq(0);
                if ($swipeStepEl.length) {
                    var offsetHeight = el[0].offsetHeight;
                    var swipeStepTranslate =
                        offsetHeight - ($swipeStepEl.offset().top - el.offset().top + $swipeStepEl[0].offsetHeight);

                    self.swipeStepTranslate = swipeStepTranslate;
                    self.offsetHeight = offsetHeight;

                    // negative
                    var sstep = -offsetHeight + swipeStepTranslate;
                    var sstep_progress = Math.round(-offsetHeight + swipeStepTranslate * (1 - progress));

                    /*console.log("swipeStepTranslate",
                        swipeStepTranslate, offsetHeight, Math.round(progress * 100) + "%", sstep_progress,
                        sstep); */

                    self.$$('#main-fab')[0].style.setProperty("--vy-swipe-step", "" + sstep + "px");
                    self.$$('#main-fab')[0].style.setProperty("--vy-swipe-open", "" + (-offsetHeight) + "px");
                    self.$$('#main-fab')[0].style.setProperty("--vy-swipe-step-progress", "" + sstep_progress +
                        "px");

                    if (self.selectedPlace && open) {
                        var coord = self.selectedPlace.place.coords;
                        var pos = L.latLng(coord.lat, coord.lon);
                        self.fitMapToPoint(pos, 500, offsetHeight);
                    }
                }
            },
        },
        on: {
            pageInit: function () {

                console.log("PAGE INIT");


                var self = this;
                var app = self.$app;

                if (!self.autocompleteToDest)
                    self.autocompleteToDest = {
                        inputEl: '#autocomplete-dropdown-expand-to-dest',
                        openIn: 'dropdown',
                        preloader: true, //enable preloader
                        /* If we set valueProperty to "id" then input value on select will be set according to this property */
                        valueProperty: 'name', //object's "value" property name
                        textProperty: 'name', //object's "text" property name
                        limit: 20, //limit to 20 results
                        typeahead: false,
                        dropdownPlaceholderText: '',

                        //value: 'Knivsta station (Knivsta)',// this.$root.toJourney?this.$root.toJourney:'',

                        // overloading renderItem in order to add icons for place, stoparea, ...
                        renderItem: function (item, index) {
                            const ac = this;
                            //if (ac.params.renderItem) return ac.params.renderItem.call(ac, item, index);
                            let itemHtml;
                            const itemValue = item.value && typeof item.value === 'string' ?
                                item.value.replace(/"/g, '&quot;') : item.value;
                            // we only do the dropdown case here, for details see autocomplete-class.js renderItem()
                            if (item.placeholder) {
                                // Dropwdown placeholder
                                itemHtml = `
                                <li class="autocomplete-dropdown-placeholder">
                                <label class="item-content">
                                    <div class="item-inner">
                                    <div class="item-title">${item.text}</div>
                                    </div>
                                </label>
                                </li>
                            `;
                                return itemHtml.trim();
                            }
                            itemHtml = `
                            <li>
                            <label class="item-radio item-content" data-value="${itemValue}">
                                <div class="item-media">
                                    <i class="icon f7-icons if-not-md">plus_circle</i>
                                        <i class="icon material-icons md-only">directions_bus</i>
                                </div>
                                <div class="item-inner">
                                        <div class="item-title">${item.text}</div>
                                </div>
                            </label>
                            </li>
                        `;
                            return itemHtml.trim();
                        },
                        source: function (query, render) {
                            var autocomplete = this;
                            var results = [];
                            if (query.length === 0) {
                                render(results);
                                return;
                            }
                            // Show Preloader
                            autocomplete.preloaderShow();
                            Journeys.getPlaces(query, 10, function (places) {
                                //console.log();
                                render(places);
                                // Hide Preoloader
                                autocomplete.preloaderHide();
                            });
                        },
                        on: {
                            change: function (value) {
                                var sa = value[0].stop_area;

                                self.updatePlace("stop_area", {
                                        coords: sa.coord,
                                        name: sa.name,
                                        label: sa.label,
                                        id: sa.id
                                    }
                                );
                            }
                        }
                    };
                var acFrom = app.autocomplete.create(self.autocompleteToDest);

                if (!self.sheetSwipeToStep) {
                    self.sheet = {
                        el: '.demo-sheet-swipe-to-step',
                        backdrop: false, // want to display map nicely - not dark
                        swipeToClose: true,
                        swipeToStep: true,
                        push: true,
                        on: {
                            stepProgress: function (value, progress) {
                                //console.log('Sheet stepProgress');
                                self.sheetOnTheMove(progress, false);
                            },
                            open: function (sheet) {
                                //console.log('Sheet open');
                                self.sheetOnTheMove(1, true);
                            },
                            opened: function (sheet) {
                                //console.log('Sheet opened');
                            },
                            stepOpen: function (sheet) {
                                //console.log('Sheet step open');
                            },
                            stepClose: function (sheet) {
                                //console.log('Sheet step closed');
                                //self.sheetOnTheMove(0, false);
                            },
                        }
                    };
                    self.sheetSwipeToStep = app.sheet.create(self.sheet);
                }

            },
            pageAfterIn: function () {
                var self = this;
                if (self.mapInitialized) return;
                if (!window.L) {
                    //self.loadMapAssets();
                    return;
                }
                self.initMap();
            },
            pageBeforeOut: function () {
                var self = this;
                if (self.sheetSwipeToStep) self.sheetSwipeToStep.close();
            },
            pageBeforeRemove: function () {
                var self = this;
                // Destroy sheet modal when page removed
                if (self.sheetSwipeToStep) self.sheetSwipeToStep.destroy();
            },
        },
    }
</script>